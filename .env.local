"use client";

import React, { useMemo, useState } from "react";

type Role = "candidate" | "recruiter";

type KandraiResponse = {
  kandrai_engine?: string;
  engine_status?: string;

  analysis_metadata?: {
    processing_mode?: string;
    comparison_pool_size?: number;
    market_benchmark?: string;
  };

  executive_summary?: {
    one_line_verdict?: string;
    hire_now_vs_later?: string;
    replacement_cost_risk?: string;
    executive_action?: string;
  };

  match_score?: {
    percentage?: number;
    label?: string;
    confidence_index?: number;
    confidence_explanation?: string;
    market_context?: string;
    brutal_honesty?: string;
  };

  comparison_matrix?: {
    this_candidate?: { rank?: number; score?: number; risk?: string; velocity?: string };
    best_candidate?: { rank?: number; score?: number; risk?: string; velocity?: string };
    delta_summary?: string;
  };

  decision_trace?: {
    score_contributors?: Array<{ factor?: string; weight?: number; impact?: number }>;
    penalties?: Array<{ factor?: string; weight?: number; impact?: number }>;
  };

  gap_analysis?: {
    technical_debt?: string[];
    behavioral_red_flags?: string;
  };

  recruiter_premium_intelligence?: {
    business_metrics?: {
      time_to_productivity_estimate?: string;
      training_cost_risk?: string;
      market_salary_alignment?: string;
    };
  };

  interview_intelligence?: Array<{
    focus?: string;
    question?: string;
    red_flag_trigger?: string;
  }>;

  ui_hints?: {
    theme?: string;
    score_color?: string;
    risk_badge?: string;
    sections_priority?: string[];
  };

  // fallback
  [key: string]: any;
};

function safeNum(n: any, fallback = 0) {
  const x = Number(n);
  return Number.isFinite(x) ? x : fallback;
}

function Badge({ children }: { children: React.ReactNode }) {
  return (
    <span
      style={{
        fontSize: 12,
        padding: "4px 10px",
        borderRadius: 999,
        border: "1px solid rgba(255,255,255,0.14)",
        background: "rgba(255,255,255,0.06)",
      }}
    >
      {children}
    </span>
  );
}

function Card({ title, children, right }: { title: string; children: React.ReactNode; right?: React.ReactNode }) {
  return (
    <div
      style={{
        borderRadius: 16,
        border: "1px solid rgba(255,255,255,0.10)",
        background: "rgba(0,0,0,0.25)",
        padding: 16,
      }}
    >
      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 12 }}>
        <h3 style={{ margin: 0, fontSize: 14, letterSpacing: 0.2, opacity: 0.9 }}>{title}</h3>
        {right}
      </div>
      <div style={{ marginTop: 12 }}>{children}</div>
    </div>
  );
}

function ProgressBar({ value, color }: { value: number; color?: string }) {
  const v = Math.max(0, Math.min(100, value));
  return (
    <div
      style={{
        height: 10,
        borderRadius: 999,
        background: "rgba(255,255,255,0.10)",
        overflow: "hidden",
      }}
    >
      <div
        style={{
          width: `${v}%`,
          height: "100%",
          background: color || "rgba(255,255,255,0.35)",
        }}
      />
    </div>
  );
}

export default function AnalyzePage() {
  const [role, setRole] = useState<Role>("candidate");
  const [tier, setTier] = useState<"free" | "premium" | "enterprise">("free");

  const [jobDescription, setJobDescription] = useState("");
  const [candidateText, setCandidateText] = useState("");
  const [recruiterDoubt, setRecruiterDoubt] = useState("");

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string>("");
  const [data, setData] = useState<KandraiResponse | null>(null);

  const apiBase = useMemo(() => {
    return process.env.NEXT_PUBLIC_API_URL || "http://127.0.0.1:8000";
  }, []);

  const score = safeNum(data?.match_score?.percentage, 0);
  const scoreColor = data?.ui_hints?.score_color || "#FFB800";

  async function onAnalyze() {
    setError("");
    setData(null);

    if (!jobDescription.trim() || !candidateText.trim()) {
      setError("Add Job Description + CV text.");
      return;
    }

    setLoading(true);
    try {
      const payload = {
        role,
        job_description: jobDescription,
        candidate_text: candidateText,
        recruiter_doubt: recruiterDoubt || "",
        // tier is not used by backend yet; we keep it for future paywall logic
        tier,
      };

      const res = await fetch(`${apiBase}/analyze`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`API error ${res.status}: ${txt || "Unknown error"}`);
      }

      const json = (await res.json()) as KandraiResponse;
      setData(json);
    } catch (e: any) {
      setError(e?.message || "Unknown error");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div
      style={{
        minHeight: "100vh",
        background: "radial-gradient(1200px 600px at 10% 0%, rgba(255,184,0,0.18), transparent 60%), #0b0e14",
        color: "white",
        padding: 24,
      }}
    >
      <div style={{ maxWidth: 1100, margin: "0 auto" }}>
        <div style={{ display: "flex", alignItems: "flex-end", justifyContent: "space-between", gap: 12 }}>
          <div>
            <h1 style={{ margin: 0, fontSize: 26 }}>Kandrai</h1>
            <p style={{ margin: "6px 0 0", opacity: 0.7, fontSize: 13 }}>
              Recruitment Intelligence — UI-ready output
            </p>
          </div>

          <div style={{ display: "flex", gap: 10, alignItems: "center", flexWrap: "wrap" }}>
            <label style={{ fontSize: 12, opacity: 0.8 }}>Role</label>
            <select
              value={role}
              onChange={(e) => setRole(e.target.value as Role)}
              style={{
                background: "rgba(255,255,255,0.06)",
                border: "1px solid rgba(255,255,255,0.12)",
                color: "white",
                borderRadius: 10,
                padding: "8px 10px",
              }}
            >
              <option value="candidate">Candidate</option>
              <option value="recruiter">Recruiter</option>
            </select>

            <label style={{ fontSize: 12, opacity: 0.8 }}>Tier</label>
            <select
              value={tier}
              onChange={(e) => setTier(e.target.value as any)}
              style={{
                background: "rgba(255,255,255,0.06)",
                border: "1px solid rgba(255,255,255,0.12)",
                color: "white",
                borderRadius: 10,
                padding: "8px 10px",
              }}
            >
              <option value="free">Free</option>
              <option value="premium">Premium</option>
              <option value="enterprise">Enterprise</option>
            </select>
          </div>
        </div>

        {/* INPUTS */}
        <div style={{ marginTop: 18, display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
          <div>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
              <h2 style={{ margin: 0, fontSize: 14, opacity: 0.9 }}>Job Description</h2>
              <Badge>{jobDescription.length} chars</Badge>
            </div>
            <textarea
              value={jobDescription}
              onChange={(e) => setJobDescription(e.target.value)}
              placeholder="Paste the Job Description…"
              style={{
                marginTop: 10,
                width: "100%",
                minHeight: 220,
                borderRadius: 14,
                border: "1px solid rgba(255,255,255,0.10)",
                background: "rgba(255,255,255,0.04)",
                color: "white",
                padding: 12,
                outline: "none",
                resize: "vertical",
              }}
            />
          </div>

          <div>
            <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
              <h2 style={{ margin: 0, fontSize: 14, opacity: 0.9 }}>CV / Candidate Text</h2>
              <Badge>{candidateText.length} chars</Badge>
            </div>
            <textarea
              value={candidateText}
              onChange={(e) => setCandidateText(e.target.value)}
              placeholder="Paste the CV…"
              style={{
                marginTop: 10,
                width: "100%",
                minHeight: 220,
                borderRadius: 14,
                border: "1px solid rgba(255,255,255,0.10)",
                background: "rgba(255,255,255,0.04)",
                color: "white",
                padding: 12,
                outline: "none",
                resize: "vertical",
              }}
            />
          </div>
        </div>

        <div style={{ marginTop: 12 }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
            <h2 style={{ margin: 0, fontSize: 14, opacity: 0.9 }}>Recruiter doubt (optional)</h2>
            <Badge>{recruiterDoubt.length} chars</Badge>
          </div>
          <textarea
            value={recruiterDoubt}
            onChange={(e) => setRecruiterDoubt(e.target.value)}
            placeholder="Optional: what do you want to verify?"
            style={{
              marginTop: 10,
              width: "100%",
              minHeight: 90,
              borderRadius: 14,
              border: "1px solid rgba(255,255,255,0.10)",
              background: "rgba(255,255,255,0.04)",
              color: "white",
              padding: 12,
              outline: "none",
              resize: "vertical",
            }}
          />
        </div>

        <div style={{ marginTop: 12, display: "flex", gap: 10, alignItems: "center" }}>
          <button
            onClick={onAnalyze}
            disabled={loading}
            style={{
              borderRadius: 12,
              border: "1px solid rgba(255,255,255,0.14)",
              background: loading ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.12)",
              color: "white",
              padding: "10px 14px",
              cursor: loading ? "not-allowed" : "pointer",
              fontWeight: 600,
            }}
          >
            {loading ? "Analyzing…" : "Analyze"}
          </button>

          <span style={{ opacity: 0.65, fontSize: 12 }}>
            API: {apiBase}
          </span>
        </div>

        {error ? (
          <div style={{ marginTop: 12, color: "#ff6b6b", fontSize: 13 }}>{error}</div>
        ) : null}

        {/* OUTPUT */}
        {data ? (
          <div style={{ marginTop: 18, display: "grid", gridTemplateColumns: "1.25fr 0.75fr", gap: 14 }}>
            <div style={{ display: "grid", gap: 14 }}>
              <Card title="Executive Summary" right={<Badge>{data?.analysis_metadata?.processing_mode || role}</Badge>}>
                <div style={{ display: "grid", gap: 8, fontSize: 13, opacity: 0.9 }}>
                  <div><b>Verdict:</b> {data?.executive_summary?.one_line_verdict || "-"}</div>
                  <div><b>Hire timing:</b> {data?.executive_summary?.hire_now_vs_later || "-"}</div>
                  <div><b>Replacement risk:</b> {data?.executive_summary?.replacement_cost_risk || "-"}</div>
                  <div><b>Action:</b> {data?.executive_summary?.executive_action || "-"}</div>
                </div>
              </Card>

              <Card
                title="Match Score"
                right={<Badge>{data?.match_score?.label || "—"}</Badge>}
              >
                <div style={{ display: "flex", alignItems: "baseline", justifyContent: "space-between", gap: 12 }}>
                  <div style={{ fontSize: 46, fontWeight: 800, letterSpacing: -1 }}>{score}%</div>
                  <div style={{ textAlign: "right", fontSize: 12, opacity: 0.75 }}>
                    <div><b>Confidence:</b> {safeNum(data?.match_score?.confidence_index, 0).toFixed(2)}</div>
                    <div>{data?.match_score?.market_context || ""}</div>
                  </div>
                </div>
                <div style={{ marginTop: 10 }}>
                  <ProgressBar value={score} color={scoreColor} />
                </div>
                <div style={{ marginTop: 10, fontSize: 13, opacity: 0.9 }}>
                  <div><b>Why confidence ≠ risk:</b> {data?.match_score?.confidence_explanation || "-"}</div>
                  <div style={{ marginTop: 6 }}><b>Brutal honesty:</b> {data?.match_score?.brutal_honesty || "-"}</div>
                </div>
              </Card>

              <Card title="Decision Trace">
                <div style={{ display: "grid", gap: 10 }}>
                  <div>
                    <div style={{ fontSize: 12, opacity: 0.7, marginBottom: 6 }}>Contributors</div>
                    <div style={{ display: "grid", gap: 6 }}>
                      {(data?.decision_trace?.score_contributors || []).map((x, i) => (
                        <div key={`c-${i}`} style={{ display: "grid", gridTemplateColumns: "1fr 90px 70px", gap: 10, fontSize: 13 }}>
                          <div style={{ opacity: 0.95 }}>{x.factor}</div>
                          <div style={{ opacity: 0.7, textAlign: "right" }}>w={safeNum(x.weight, 0).toFixed(2)}</div>
                          <div style={{ textAlign: "right", fontWeight: 700 }}>+{safeNum(x.impact, 0)}</div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div>
                    <div style={{ fontSize: 12, opacity: 0.7, marginBottom: 6 }}>Penalties</div>
                    <div style={{ display: "grid", gap: 6 }}>
                      {(data?.decision_trace?.penalties || []).map((x, i) => (
                        <div key={`p-${i}`} style={{ display: "grid", gridTemplateColumns: "1fr 90px 70px", gap: 10, fontSize: 13 }}>
                          <div style={{ opacity: 0.95 }}>{x.factor}</div>
                          <div style={{ opacity: 0.7, textAlign: "right" }}>w={safeNum(x.weight, 0).toFixed(2)}</div>
                          <div style={{ textAlign: "right", fontWeight: 700 }}>{safeNum(x.impact, 0)}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </Card>

              <Card title="Gap Analysis">
                <div style={{ fontSize: 13, opacity: 0.9 }}>
                  <div><b>Technical debt:</b></div>
                  <ul style={{ marginTop: 6 }}>
                    {(data?.gap_analysis?.technical_debt || []).map((x, i) => (
                      <li key={`td-${i}`}>{x}</li>
                    ))}
                  </ul>
                  <div style={{ marginTop: 8 }}><b>Behavioral red flags:</b> {data?.gap_analysis?.behavioral_red_flags || "-"}</div>
                </div>
              </Card>

              <Card title="Interview Intelligence">
                <div style={{ display: "grid", gap: 10 }}>
                  {(data?.interview_intelligence || []).map((q, i) => (
                    <div
                      key={`q-${i}`}
                      style={{
                        borderRadius: 12,
                        border: "1px solid rgba(255,255,255,0.10)",
                        padding: 12,
                        background: "rgba(255,255,255,0.03)",
                      }}
                    >
                      <div style={{ display: "flex", gap: 10, alignItems: "center", flexWrap: "wrap" }}>
                        <Badge>{q.focus || "Focus"}</Badge>
                      </div>
                      <div style={{ marginTop: 8, fontSize: 13 }}><b>Question:</b> {q.question || "-"}</div>
                      <div style={{ marginTop: 6, fontSize: 13, opacity: 0.9 }}>
                        <b>Red flag:</b> {q.red_flag_trigger || "-"}
                      </div>
                    </div>
                  ))}
                </div>
              </Card>
            </div>

            <div style={{ display: "grid", gap: 14 }}>
              <Card title="Comparison Matrix">
                <div style={{ fontSize: 13, opacity: 0.9, display: "grid", gap: 10 }}>
                  <div>
                    <div style={{ opacity: 0.7, fontSize: 12, marginBottom: 6 }}>This candidate</div>
                    <div><b>Rank:</b> {data?.comparison_matrix?.this_candidate?.rank ?? "-"}</div>
                    <div><b>Score:</b> {data?.comparison_matrix?.this_candidate?.score ?? "-"}</div>
                    <div><b>Risk:</b> {data?.comparison_matrix?.this_candidate?.risk ?? "-"}</div>
                    <div><b>Velocity:</b> {data?.comparison_matrix?.this_candidate?.velocity ?? "-"}</div>
                  </div>

                  <div>
                    <div style={{ opacity: 0.7, fontSize: 12, marginBottom: 6 }}>Best candidate</div>
                    <div><b>Rank:</b> {data?.comparison_matrix?.best_candidate?.rank ?? "-"}</div>
                    <div><b>Score:</b> {data?.comparison_matrix?.best_candidate?.score ?? "-"}</div>
                    <div><b>Risk:</b> {data?.comparison_matrix?.best_candidate?.risk ?? "-"}</div>
                    <div><b>Velocity:</b> {data?.comparison_matrix?.best_candidate?.velocity ?? "-"}</div>
                  </div>

                  <div style={{ borderTop: "1px solid rgba(255,255,255,0.10)", paddingTop: 10 }}>
                    <div style={{ opacity: 0.7, fontSize: 12, marginBottom: 6 }}>Delta</div>
                    <div>{data?.comparison_matrix?.delta_summary || "-"}</div>
                  </div>
                </div>
              </Card>

              <Card title="Recruiter Premium Intelligence">
                <div style={{ fontSize: 13, opacity: 0.9, display: "grid", gap: 8 }}>
                  <div>
                    <b>Time to productivity:</b>{" "}
                    {data?.recruiter_premium_intelligence?.business_metrics?.time_to_productivity_estimate || "-"}
                  </div>
                  <div>
                    <b>Training cost risk:</b>{" "}
                    {data?.recruiter_premium_intelligence?.business_metrics?.training_cost_risk || "-"}
                  </div>
                  <div>
                    <b>Salary alignment:</b>{" "}
                    {data?.recruiter_premium_intelligence?.business_metrics?.market_salary_alignment || "-"}
                  </div>
                </div>
              </Card>

              <Card title="Raw JSON">
                <pre
                  style={{
                    margin: 0,
                    fontSize: 11,
                    lineHeight: 1.35,
                    whiteSpace: "pre-wrap",
                    wordBreak: "break-word",
                    opacity: 0.85,
                  }}
                >
                  {JSON.stringify(data, null, 2)}
                </pre>
              </Card>
            </div>
          </div>
        ) : null}
      </div>
    </div>
  );
}
